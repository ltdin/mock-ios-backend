rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Public readable (levels + leaderboards), write chỉ qua Cloud Functions
    match /levels/{levelId} {
      allow read: if true;
      allow write: if false;
    }

    match /leaderboards_total/{uid} {
      allow read: if true;
      allow write: if false; // chỉ Functions
    }

    match /leaderboards_level/{levelId}/entries/{uid} {
      allow read: if true;
      allow write: if false; // chỉ Functions
    }

    // Users: user chỉ đọc/sửa hồ sơ của chính mình (không cho sửa trường hệ thống)
    match /users/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if request.auth != null && request.auth.uid == uid
        && !('totalScore' in request.resource.data)
        && !('bestScores' in request.resource.data)
        && !('unlockedLevel' in request.resource.data);
    }
  }
}
